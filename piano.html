<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Piano Keyboard</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸŽ¹</text></svg>">
    <style>
        .piano-container {
            display: inline-block;
            background-color: rgb(220, 220, 220);
            padding: 20px; /* Frame thickness */
            border-radius: 10px; /* Rounded corners for the frame */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); /* Subtle shadow for depth */
        }
        .piano {
            display: flex;
            margin-top: 20px;
        }
        .key {
            width: 40px;
            height: 220px;
            border: 1px solid #000;
            background-color: white;
            cursor: pointer;
            border-radius: 0 0 8px 8px; /* Rounded corners at the bottom */
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.3); /* Add a subtle shadow */
            transition: background-color 0.1s ease; /* Smooth transition for highlighting */
        }
        .key.black {
            width: 25px;
            height: 140px;
            background-color: black;
            margin-left: -15px;
            margin-right: -15px;
            z-index: 1;
            border-radius: 0 0 6px 6px; /* Rounded corners for black keys */
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.5); /* Darker shadow for black keys */
        }
        .key.active {
            background-color: #ccc; /* Highlight color when key is pressed */
        }
        .key.black.active {
            background-color: #555; /* Darker highlight for black keys */
        }
        .key.highlighted {
            background-color: #ff4444; /* Red highlight for white keys */
        }
        .key.black.highlighted {
            background-color: #cc0000; /* Darker red highlight for black keys */
        }
    </style>
</head>
<body>
    <div id="pianocontainer" class="piano-container">
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script>

        function generateKeys(octaves = ["C4", "C5"], extraHighCAfter = true) {
            const notes = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
            let keys = [];

            octaves.forEach(octave => {
                const octaveNum = octave.slice(-1);
                notes.forEach(note => {
                    const fullNote = `${note}${octaveNum}`;
                    const keyClass = note.includes("#") ? "key black" : "key";
                    keys.push(`<div class="${keyClass}" data-note="${fullNote}"></div>`);
                });
            });

            if (extraHighCAfter) {
                const lastOctaveNum = parseInt(octaves[octaves.length - 1].slice(-1)) + 1;
                const extraC = `<div class="key" data-note="C${lastOctaveNum}"></div>`;
                keys.push(extraC);
            }

            return `<div class="piano">\n${keys.join("\n")}\n</div>`;
        }

        // Usage: Add the piano keys to the "piano_container" div
        function addPianoToContainer() {
            // Generate the piano keys
            const pianoKeys = generateKeys(["C4", "C5"], true);

            // Select the "piano_container" div
            const pianoContainer = document.getElementById("pianocontainer");

            // Add the generated piano keys to the container
            pianoContainer.innerHTML = pianoKeys;
        }

        // Call the function to add the piano to the container
        addPianoToContainer();

        // Create a new sampler to play sounds via Tone.js
        const piano = new Tone.Sampler({
            urls: {
                "C4": "C4.mp3",
                "C#4": "Db4.mp3",
                "Db4": "Db4.mp3",
                "D4": "D4.mp3",
                "D#4": "Eb4.mp3",
                "Eb4": "Eb4.mp3",
                "E4": "E4.mp3",
                "F4": "F4.mp3",
                "F#4": "Gb4.mp3",
                "Gb4": "Gb4.mp3",
                "G4": "G4.mp3",
                "Ab4": "Ab4.mp3",
                "G#4": "Ab4.mp3",
                "A4": "A4.mp3",
                "A#4": "Bb4.mp3",
                "Bb4": "Bb4.mp3",
                "B4": "B4.mp3",
            },
            baseUrl: "https://gleitz.github.io/midi-js-soundfonts/FatBoy/acoustic_grand_piano-mp3/", // Piano soundfont
            onload: () => {
                console.log("Piano loaded!");
            }
        }).toDestination();

        let isMouseDown = false; // Track if the mouse button is pressed
        let lastPlayedNote = null; // Track the last played note to avoid repeats

        // Function to play a note
        function playNote(note) {
            if (Tone.context.state !== 'running') {
                Tone.context.resume(); // Resume the AudioContext if it's suspended
            }
            piano.triggerAttackRelease(note, "8n"); // Play the note for an 8th note duration
        }

        const keys = document.querySelectorAll('.key');

        // Function to highlight a key, e.g., to show when a note is played, or to instruct somebody which key to press
        // @param {String} note - The note to highlight, e.g., "C", "D#", "F#"
        // @param {Number} highlightTime - The time in milliseconds to keep the key highlighted. Set to 0 to keep it highlighted indefinitely.
        function highlightKey(note, highlightTime = 0) {
            keys.forEach(key => {
                if (key.dataset.note === note) {
                    key.classList.add('highlighted');
                    if (highlightTime > 0) {
                        setTimeout(() => {
                            key.classList.remove('highlighted');
                        }, highlightTime);
                    }
                }
            });
        }

        // Function to remove all highlights
        function removeHighlights() {
            keys.forEach(key => {
                key.classList.remove('highlighted');
            });
        }

        // Add event listeners to each key
        keys.forEach(key => {
            key.addEventListener('mousedown', () => {
                isMouseDown = true;
                key.classList.add('active');
                // Play sound or perform other actions here
                const note = key.dataset.note;
                console.log(note);
                playNote(note);
                lastPlayedNote = note;
            });

            // Handle mouse move
            key.addEventListener('mousemove', () => {
                if (isMouseDown) {
                    key.classList.add('active');
                    const note = key.dataset.note;
                    if (note !== lastPlayedNote) { // Avoid playing the same note repeatedly
                        playNote(note);
                        lastPlayedNote = note; // Update the last played note
                    }
                }
            });

            // Handle mouse up
            key.addEventListener('mouseup', () => {
                isMouseDown = false;
                lastPlayedNote = null; // Reset the last played note
            });

            // Handle mouse leave
            key.addEventListener('mouseleave', () => {
                key.classList.remove('active');
            });
        });

        // Handle mouse up globally (in case the mouse is released outside a key)
        document.addEventListener('mouseup', () => {
            isMouseDown = false;
            lastPlayedNote = null; // Reset the last played note
        });

        // trigger a note when a key is pressed on the computer keyboard. In that case we also highlight the key.
        function triggerNote(note) {
            playNote(note);
            highlightKey(note, 200);
        }

        document.addEventListener('keydown', (event) => {
            const keyMap = {  // TODO: this keymap is specific to English/German keyboards, provide alternatives for other keyboard layouts.
                'a': 'C4', // flats
                's': 'D4',
                'd': 'E4',
                'f': 'F4',
                'g': 'G4',
                'h': 'A4',
                'j': 'B4',
                'A': 'C#4', // sharps
                'w': 'C#4',
                'S': 'D#4',
                'e': 'D#4',
                'F': 'F#4',
                't': 'F#4',
                'G': 'G#4',
                'y': 'G#4',
                'z': 'G#4',  // also allow z as replacement for y (for German QWERTZ keyboards)
                'H': 'A#4',
                'u': 'A#4'
            };

            const note = keyMap[event.key]; // Get the corresponding note
            if (note) { // If the key is in the keyMap
                triggerNote(note); // Play the note
            }
        });

    </script>
</body>
</html>