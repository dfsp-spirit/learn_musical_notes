<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NoteMaster: Musical Quiz</title>
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/abcjs/6.0.0/abcjs-basic-min.js"></script> -->
    <script src="./abcjs-basic-min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; }
        #settings {
            display: none; /* Hidden by default */
            padding: 10px;
            border: 1px solid #ccc;
            margin-top: 10px;
        }
        #toggle-settings {
            cursor: pointer;
            background: none;
            border: none;
            font-size: 16px;
        }
        #timings {
            display: none; /* Hidden by default */
            padding: 10px;
            border: 1px solid #ccc;
            margin-top: 10px;
        }
        #toggle-timings {
            cursor: pointer;
            background: none;
            border: none;
            font-size: 16px;
        }
        #score_status { margin: 20px; min-height: 40px; }
        #time_status { margin: 20px; min-height: 40px; }
        #buttons { margin-top: 20px; }
        button { margin: 5px; padding: 10px; font-size: 16px; }
        button:disabled {
            background-color: gray;
            color: white;
            cursor: not-allowed;
            opacity: 0.6;
        }
        #notation { margin: 0 auto; width: 200px; min-height: 80px; }
    </style>
</head>
<body>
    <h1>NoteMaster: Identify the Musical Note</h1>

    <button id="toggle-settings" title="Toggle display of settings">▶ Settings</button>
    <div id="settings">
        <div id="setting_notation" title="The note nomenclature system">Nomenclature:
            <label>
                <input type="radio" name="notation" value="international" checked> International
            </label>
            <label>
                <input type="radio" name="notation" value="german"> German
            </label>
            <label>
                <input type="radio" name="notation" value="solfege">Solfège
            </label>
        </div>
        <br>
        <div id="octave-settings" title="The octaves to include, in scientific pitch notation."></div>
        <br>
        <div id="setting_clef" title="The clef to use. Setting it to auto will use a suitable clef based on the note. If you force a clef, you may want to limit octaves above.">
            Clef:
            <label>
                <input type="radio" name="clef" value="auto" checked> <i>Auto</i>
            </label>
            <label>
                <input type="radio" name="clef" value="bass"> Bass
            </label>
            <label>
                <input type="radio" name="clef" value="treble"> Treble
            </label>
            <label>
                <input type="radio" name="clef" value="alto"> Alto
            </label>
        </div>

    </div>
    <button id="toggle-timings" title="Toggle display of timings">▶ Timings</button>
    <div id="timings">
        <br>
        <button id="startOverButton" title="Reset score and timers.">Start over</button>
        <br>
        <h4>Timer</h4>
        <p>Total time elapsed: <span id="timer_overall">0.00</span> seconds</p>
        <p>Note has been displayed for: <span id="timer_current_note">0.00</span> seconds</p>
        <p title="Need at least 5 successful identifications.">Average time for successful identifications:<span id="time_status" title="Need at least 5 successful identifications.">?</span></p>

    </div>

    <div id="score_status" title="Go for it!">Click the correct note name!
    </div>


    <div id="notation"></div>
    <div id="buttons"></div>
    <p id="result"></p>

    <script>
        const noteSystems = {
            international: ["C", "D", "E", "F", "G", "A", "B"],
            german: ["C", "D", "E", "F", "G", "A", "H"],
            solfege: ["Do", "Re", "Mi", "Fa", "Sol", "La", "Si"]
        };

        let num_correct = 0;
        let num_tries = 0;

        let overall_start_time;  // when the quiz started
        let display_note_start_time;  // when the current note was displayed
        let display_note_interval = null;
        let correct_identification_times = [];

        let currentNotation = JSON.parse(localStorage.getItem("currentNotation")) || "international";
        let currentNote = "";

        let currentClef = JSON.parse(localStorage.getItem("currentClef")) || "auto";

        let availableOctaves = ["C1", "C2", "C3", "C4", "C5"]; // Initial list
        let selectedOctaves = JSON.parse(localStorage.getItem("selectedOctaves")) || ["C3", "C4"];

        function updateOctaves() {
            selectedOctaves = Array.from(document.querySelectorAll('input[name="octave"]:checked'))
                                .map(checkbox => checkbox.value);

            // If none is selected, select all.
            if(selectedOctaves.length === 0) {
                selectedOctaves = [...availableOctaves];
            }

            localStorage.setItem("selectedOctaves", JSON.stringify(selectedOctaves)); // Save to localStorage
            console.log("Selected octaves: ", selectedOctaves); // For debugging
            renderMusicalNote();
        }

        function generateIncludedOctavesCheckboxes() {
            const container = document.getElementById("octave-settings");
            container.innerHTML = "Octaves (SPN):";

            availableOctaves.forEach(octave => {
                const label = document.createElement("label");
                const isChecked = selectedOctaves.includes(octave) ? "checked" : "";
                label.innerHTML = `<input type="checkbox" name="octave" value="${octave}" ${isChecked}> ${octave}`;
                container.appendChild(label);
                //container.appendChild(document.createElement("br"));
            });

            document.querySelectorAll('input[name="octave"]').forEach(checkbox => {
                checkbox.addEventListener("change", updateOctaves);
            });
        }

        function getRandomNote() {
            const notes = noteSystems[currentNotation];
            return notes[Math.floor(Math.random() * notes.length)];
        }

        function getRandomOctaveFrom(octaves = ["C1", "C2", "C3", "C4", "C5"]) {
            return octaves[Math.floor(Math.random() * octaves.length)];
        }

        function toOctaveSPN(noteName, octave="C4") {

            if(octave === "random") {
                octave = getRandomOctaveFrom();
            }

            // If octave is a list of strings, treat it as a list of allowed octaves
            if(Array.isArray(octave)) {
                octave = getRandomOctaveFrom(octave);
            }

            const note = noteName.toUpperCase();
            let note_out = note;
            let suggested_clef = "treble";
            if(octave === "C1") {
                note_out = note + ",,";
                suggested_clef = "bass";
            } else if (octave === "C2") {
                note_out = note + ",";
                suggested_clef = "bass";
            } else if (octave === "C3") {
                note_out = note;
                suggested_clef = "treble";
            } else if (octave === "C4") {
                note_out = note.toLowerCase();
                suggested_clef = "treble";
            } else if (octave === "C5") {
                note_out = note.toLowerCase() + "'";
                suggested_clef = "treble";
            } else if (octave === "C6") {
                note_out = note.toLowerCase() + "''";
                suggested_clef = "treble";
            } else {
                console.error("Invalid octave");
            }
            console.log("Transforming note", note, "to", note_out, "in octave", octave, ". Suggested clef:", suggested_clef);
            return [note_out, suggested_clef];
        }

        function renderMusicalNote() {
            currentNote = getRandomNote();
            const noteName = noteSystems["international"][noteSystems[currentNotation].indexOf(currentNote)];
            const [noteNameSPN, suggestedCleve] = toOctaveSPN(noteName, selectedOctaves);
            const usedclef = currentClef === "auto" ? suggestedCleve : currentClef;
            const abcString = `X:1\nL:1/4\nK:C ${usedclef}\n ${noteNameSPN}`;
            ABCJS.renderAbc("notation", abcString);

            // set overall time if not set yet
            if (!overall_start_time) {
                overall_start_time = Date.now();
            }

            display_note_start_time = Date.now();
            if (display_note_interval) clearInterval(display_note_interval);

            // Update total time every 100 ms
            display_note_interval = setInterval(() => {
                let elapsedSeconds = (Date.now() - overall_start_time) / 1000;
                document.getElementById("timer_overall").textContent = elapsedSeconds.toFixed(0);
            }, 1000);

            // Update current note time every 100 ms
            display_note_interval = setInterval(() => {
                let elapsedSeconds = (Date.now() - display_note_start_time) / 1000;
                document.getElementById("timer_current_note").textContent = elapsedSeconds.toFixed(1);
            }, 100);

            // Remove the correct/false message from previous question
            const result = document.getElementById("result");
            result.textContent = "";
            // Re-enable answer buttons
            document.querySelectorAll(".answer-btn").forEach(button => {
                button.disabled = false;
            });
        }

        function checkAnswer(note) {
            const result = document.getElementById("result");
            if (note === currentNote) {
                result.textContent = "✅ Correct, it's " + note + "!";
                num_correct++;
                const time_to_answer = Date.now() - display_note_start_time;
                correct_identification_times.push(time_to_answer);
            } else {
                result.textContent = "❌ Try again with a different note! It was " + currentNote + ", not " + note + ".";
            }
            num_tries++;
            if (display_note_interval) clearInterval(display_note_interval);
            document.getElementById("timer_current_note").textContent = "0.00"; // Reset timer
            const score_status = document.getElementById("score_status");
            score_status.textContent = `Score: ${num_correct}/${num_tries}`;
            score_status.title = "Your score. Keep it up!";

            const time_status = document.getElementById("time_status");

            // Show average time for correct clicks
            if(num_correct >= 5) {
                const average_time = correct_identification_times.reduce((a, b) => a + b, 0) / correct_identification_times.length;
                const average_time_s = average_time / 1000;
                time_status.textContent =`${average_time_s.toFixed(1)} s`;
                time_status.title = "The average time is for correct answers only.";
            }
            //

            // disable buttons until next question, so user cannot accidently answer twice
            document.querySelectorAll(".answer-btn").forEach(button => {
                button.disabled = true;
            });
            setTimeout(renderMusicalNote, 1000);
        }

        function createAnswerButtons() {
            const container = document.getElementById("buttons");
            container.innerHTML = "";
            noteSystems[currentNotation].forEach(note => {
                const btn = document.createElement("button");
                btn.textContent = note;
                btn.classList.add("answer-btn");
                btn.onclick = () => checkAnswer(note);
                container.appendChild(btn);
            });
        }

        function startOver() {
            num_correct = 0;
            num_tries = 0;
            correct_identification_times = [];
            const score_status = document.getElementById("score_status");
            score_status.textContent = `Click the correct note name!`;
            score_status.title = "Go for it!";
            overall_start_time = Date.now();
            const time_status = document.getElementById("time_status");
            time_status.textContent = `?`;
            time_status.title = "Need at least 5 successful identifications.";
            renderMusicalNote();
        }

        document.getElementById("startOverButton").addEventListener("click", startOver);


        document.querySelectorAll("input[name='notation']").forEach(radio => {
            radio.addEventListener("change", (event) => {
                currentNotation = event.target.value;
                localStorage.setItem("currentNotation", JSON.stringify(currentNotation)); // Save to localStorage
                createAnswerButtons();
            });
        });

        document.querySelectorAll("input[name='clef']").forEach(radio => {
            radio.addEventListener("change", (event) => {
                currentClef = event.target.value;
                localStorage.setItem("currentClef", JSON.stringify(currentClef)); // Save to localStorage
                renderMusicalNote();
            });
        });

        document.getElementById("toggle-settings").addEventListener("click", function() {
            const settingsDiv = document.getElementById("settings");
            const button = this;

            if (window.getComputedStyle(settingsDiv).display === "none") {
                settingsDiv.style.display = "block";
                button.textContent = "▼ Settings"; // Change arrow down
            } else {
                settingsDiv.style.display = "none";
                button.textContent = "▶ Settings"; // Change arrow right
            }
        });

        document.getElementById("toggle-timings").addEventListener("click", function() {
            const timingsDiv = document.getElementById("timings");
            const button = this;

            if (window.getComputedStyle(timingsDiv).display === "none") {
                timingsDiv.style.display = "block";
                button.textContent = "▼ Timings"; // Change arrow down
            } else {
                timingsDiv.style.display = "none";
                button.textContent = "▶ Timings"; // Change arrow right
            }
        });

        // Initialize checkboxes
        generateIncludedOctavesCheckboxes();
        createAnswerButtons();
        renderMusicalNote();
    </script>
</body>
</html>
