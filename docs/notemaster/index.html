<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NoteMaster: Musical Quiz</title>
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/abcjs/6.0.0/abcjs-basic-min.js"></script> -->
    <script src="./abcjs-basic-min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; }
        #settings {
            display: none; /* Hidden by default */
            padding: 10px;
            border: 1px solid #ccc;
            margin-top: 10px;
        }
        #toggle-settings {
            cursor: pointer;
            background: none;
            border: none;
            font-size: 16px;
        }
        #timings {
            display: none; /* Hidden by default */
            padding: 10px;
            border: 1px solid #ccc;
            margin-top: 10px;
        }
        #toggle-timings {
            cursor: pointer;
            background: none;
            border: none;
            font-size: 16px;
        }
        #score_wrapper { margin: 20px; min-height: 40px; }
        #score_status { color: rgb(0, 0, 0 ) }
        #score_status_percent { color:rgb(160, 160, 160) }
        #time_status { margin: 20px; min-height: 40px; }
        #time_status_last_ten { margin: 20px; min-height: 40px; }
        #buttons { margin-top: 20px; }
        button { margin: 5px; padding: 10px; font-size: 16px; }
        button:disabled {
            background-color: gray;
            color: white;
            cursor: not-allowed;
            opacity: 0.6;
        }
        #notation { margin: 0 auto; width: 200px; min-height: 80px; }
    </style>
</head>
<body>
    <h1>NoteMaster: Identify the Musical Note</h1>

    <button id="toggle-settings" title="Toggle display of settings">▶ Settings</button>
    <div id="settings">
        <div id="setting_notation" title="The note nomenclature system">Nomenclature:
            <label>
                <input type="radio" name="notation" value="international" checked> International
            </label>
            <label>
                <input type="radio" name="notation" value="german"> German
            </label>
            <label>
                <input type="radio" name="notation" value="solfege">Solfège
            </label>
        </div>
        <br>
        <div id="octave-settings" title="The octaves to include, in scientific pitch notation."></div>
        <br>
        <div id="setting_clef" title="The clef to use. Setting it to auto will use a suitable clef based on the note. If you force a clef, you may want to limit octaves above.">
            Clef:
            <label>
                <input type="radio" name="clef" value="auto" checked> <i>Auto</i>
            </label>
            <label>
                <input type="radio" name="clef" value="bass"> Bass
            </label>
            <label>
                <input type="radio" name="clef" value="treble"> Treble
            </label>
            <label>
                <input type="radio" name="clef" value="alto"> Alto
            </label>
        </div>

    </div>
    <button id="toggle-timings" title="Toggle display of timings">▶ Timings</button>
    <div id="timings">
        <br>
        <button id="startOverButton" title="Reset score and timers. You can also refresh the page to start over.">Start over</button>
        <br>
        <p>Total time elapsed: <span id="timer_overall">0.00</span> seconds</p>
        <p>Note has been displayed for: <span id="timer_current_note">0.00</span> seconds</p>
        <p title="Need at least 5 successful identifications.">Average time for all successful identifications:<span id="time_status" title="Need at least 5 successful identifications.">?</span></p>
        <p title="Need at least 10 successful identifications.">Average time for the last 10 successful identifications:<span id="time_status_last_ten" title="Need at least 10 successful identifications.">?</span></p>

    </div>

    <div id="score_wrapper" title="Your score.">
        <span id="score_status" title="Go for it!">Click the correct note name!</span>
        <span id="score_status_percent" title="Percentage of correct answers"></span>
    </div>


    <div id="notation"></div>
    <div id="buttons"></div>
    <p id="result"></p>

    <script>

        // note nomenclature systems
        const noteSystems = {
            international: ["C", "D", "E", "F", "G", "A", "B"],
            german: ["C", "D", "E", "F", "G", "A", "H"],
            solfege: ["Do", "Re", "Mi", "Fa", "Sol", "La", "Si"]
        };

        let num_correct = 0; // number of correct answers so far in the quiz
        let num_tries = 0;   // number of total tries so far in the quiz

        let overall_start_time;  // when the quiz started
        let display_note_start_time;  // when the current note was displayed
        let display_note_interval = null; // interval for updating the current note time
        let correct_identification_times = []; // list of times for correct identifications

        let currentNotation = JSON.parse(localStorage.getItem("currentNotation")) || "international";
        let currentNote = ""; // current note being displayed

        let currentClef = JSON.parse(localStorage.getItem("currentClef")) || "auto";   // the clef to use

        let availableOctaves = ["C1", "C2", "C3", "C4", "C5"]; // List of all octaves.
        let selectedOctaves = JSON.parse(localStorage.getItem("selectedOctaves")) || ["C3", "C4"];  // The currently selected octaves, i.e., the ones where random notes are drawn from.

        console.log("Starting...");

        // Update the current octaves. Called when user changes the checkboxes in the octave settings menu.
        function updateOctaves() {
            selectedOctaves = Array.from(document.querySelectorAll('input[name="octave"]:checked'))
                                .map(checkbox => checkbox.value);

            // If none is selected, select all.
            if(selectedOctaves.length === 0) {
                selectedOctaves = [...availableOctaves];
            }

            localStorage.setItem("selectedOctaves", JSON.stringify(selectedOctaves)); // Save to localStorage
            console.log("Selected octaves: ", selectedOctaves); // For debugging
            renderMusicalNote();
        }

        // Dynamically generate checkboxes for selecting octaves from `availableOctaves`.
        function generateIncludedOctavesCheckboxes() {
            const container = document.getElementById("octave-settings");
            container.innerHTML = "Octaves (SPN):";

            availableOctaves.forEach(octave => {
                const label = document.createElement("label");
                const isChecked = selectedOctaves.includes(octave) ? "checked" : "";
                label.innerHTML = `<input type="checkbox" name="octave" value="${octave}" ${isChecked}> ${octave}`;
                container.appendChild(label);
                //container.appendChild(document.createElement("br"));
            });

            document.querySelectorAll('input[name="octave"]').forEach(checkbox => {
                checkbox.addEventListener("change", updateOctaves);
            });
        }

        // Draw a random note from the current note system. If lastnote is provided, make sure the new note is different.
        // This draws a general note like 'C' or 'F', not a specific note in SPN like 'C4' or 'F2'. The octave is added later.
        // This function artificially makes it less likely to draw a note that is directly adjacent to the last note if lastnote is provided.
        function getRandomNote(lastnote = "") {
            const notes = noteSystems[currentNotation];
            if (lastnote === "") {  // Just draw a random note if no last note is known
                return notes[Math.floor(Math.random() * notes.length)];
            } else {
                // Use knowledge on last note to:
                //   * prevent the same note from being drawn again
                //   * make it less likely (but not impossible) to draw a note that is directly adjacent to the last note

                if (Math.random() < 0.05) { // Limit chance to draw adjacent note to 5%. Does never draw identical note.
                    const lastnoteIndex = notes.indexOf(lastnote);
                    const adjacentNotes = [notes[(lastnoteIndex + 1) % notes.length], notes[(lastnoteIndex - 1 + notes.length) % notes.length]];
                    newnote = adjacentNotes[Math.floor(Math.random() * 2)];
                } else {
                    // The vast majority of the time, draw only from the notes that are not adjacent to the last note (and not identical to it).
                    const lastnoteIndex = notes.indexOf(lastnote);
                    const nonAdjacentNotes = notes.filter(note => note !== notes[(lastnoteIndex + 1) % notes.length] && note !== notes[(lastnoteIndex - 1 + notes.length) % notes.length] && note !== lastnote);
                    newnote = nonAdjacentNotes[Math.floor(Math.random() * nonAdjacentNotes.length)];
                }

                return newnote;
            }
        }

        // Draw a random octave from the list of octaves provided. If no list is provided, use the default list.
        function getRandomOctaveFrom(octaves = ["C1", "C2", "C3", "C4", "C5", "C6"]) {
            return octaves[Math.floor(Math.random() * octaves.length)];
        }

        // Convert a note name like 'F' to a full note name in scientific pitch notation (SPN) with an octave, like 'F4'.
        // @param noteName: The note name, like `'F'`.
        // @param octave: The octave to use, like `'C4'` (or simply `"4"` or `4` if you prefer). You can also use the string `'random'` to select a random octave. If octave is an array of strings, it is treated as a list of allowed octaves to choose from.
        // @return: A tuple with the note name in SPN and the suggested clef to use. The clef is either `'treble'` or `'bass'`.
        function toOctaveSPN(noteName, octave="C4") {

            if(octave === "random") {
                octave = getRandomOctaveFrom();
            }

            // If octave is a list of strings, treat it as a list of allowed octaves
            if(Array.isArray(octave)) {
                octave = getRandomOctaveFrom(octave);
            }

            const note = noteName.toUpperCase();
            let note_out = note;
            let suggested_clef = "treble";
            if(octave === "C1" || octave === "1" || octave === 1) {
                note_out = note + ",,";
                suggested_clef = "bass";
            } else if (octave === "C2") {
                note_out = note + ",";
                suggested_clef = "bass";
            } else if (octave === "C3") {
                note_out = note;
                suggested_clef = "treble";
            } else if (octave === "C4") {
                note_out = note.toLowerCase();
                suggested_clef = "treble";
            } else if (octave === "C5") {
                note_out = note.toLowerCase() + "'";
                suggested_clef = "treble";
            } else if (octave === "C6") {
                note_out = note.toLowerCase() + "''";
                suggested_clef = "treble";
            } else {
                console.error("Invalid octave");
            }
            //console.log("Transforming note", note, "to", note_out, "in octave", octave, ". Suggested clef:", suggested_clef);
            return [note_out, suggested_clef];
        }

        // Render a new musical note on the screen and start the timer.
        function renderMusicalNote() {
            currentNote = getRandomNote(currentNote);
            const noteName = noteSystems["international"][noteSystems[currentNotation].indexOf(currentNote)];
            const [noteNameSPN, suggestedCleve] = toOctaveSPN(noteName, selectedOctaves);
            const usedclef = currentClef === "auto" ? suggestedCleve : currentClef;
            const abcString = `X:1\nL:1/4\nK:C ${usedclef}\n ${noteNameSPN}`;
            ABCJS.renderAbc("notation", abcString);

            // set overall time if not set yet
            if (!overall_start_time) {
                overall_start_time = Date.now();
            }

            display_note_start_time = Date.now();
            if (display_note_interval) clearInterval(display_note_interval);

            // Update total time every 1 second
            display_note_interval = setInterval(() => {
                let elapsedSeconds = (Date.now() - overall_start_time) / 1000;
                document.getElementById("timer_overall").textContent = elapsedSeconds.toFixed(0);
            }, 1000);

            // Update current note time every 100 ms
            display_note_interval = setInterval(() => {
                let elapsedSeconds = (Date.now() - display_note_start_time) / 1000;
                document.getElementById("timer_current_note").textContent = elapsedSeconds.toFixed(1);
            }, 100);

            // Remove the correct/false message from previous question
            const result = document.getElementById("result");
            result.textContent = "";

            // Re-enable answer buttons. They were disabled after the last question in the checkAnswer function.
            document.querySelectorAll(".answer-btn").forEach(button => {
                button.disabled = false;
            });
        }

        // Check if the answer is correct and update the score and various timings and statistics.
        function checkAnswer(note) {
            const result = document.getElementById("result");
            let isCorrect = false;
            if (note === currentNote) {
                isCorrect = true;
                result.textContent = "✅ Correct, it's " + note + "!";
                num_correct++;
                const time_to_answer = Date.now() - display_note_start_time;
                correct_identification_times.push(time_to_answer);
            } else {
                result.textContent = "❌ Try again with a different note! It was " + currentNote + ", not " + note + ".";
            }
            num_tries++;
            if (display_note_interval) clearInterval(display_note_interval);
            document.getElementById("timer_current_note").textContent = "0.0"; // Reset timer
            const score_status = document.getElementById("score_status");
            score_status.textContent = `Score: ${num_correct} / ${num_tries}`;
            const score_status_percent = document.getElementById("score_status_percent");
            // Add score percent correct after current textContent
            score_status_percent.textContent = `(${(num_correct / num_tries * 100).toFixed(0)}%)`;
            score_status.title = "Your score. Keep it up!";

            const time_status = document.getElementById("time_status");

            // Show average time for correct clicks
            if(num_correct >= 5) {
                const average_time = correct_identification_times.reduce((a, b) => a + b, 0) / correct_identification_times.length;
                const average_time_s = average_time / 1000;
                time_status.textContent =`${average_time_s.toFixed(1)} s`;
                time_status.title = "The average time is for correct answers only.";
            }

            const time_status_last_ten = document.getElementById("time_status_last_ten");
            if(num_correct >= 10) {
                const last_ten = correct_identification_times.slice(-10);
                const average_time = last_ten.reduce((a, b) => a + b, 0) / last_ten.length;
                const average_time_s_last_ten = average_time / 1000;
                time_status_last_ten.textContent =`${average_time_s_last_ten.toFixed(1)} s`;
                time_status_last_ten.title = "The average time for the last 10 correct answers.";
            }

            // Log the average time for correct clicks to console every 5 correct clicks
            if(num_correct % 5 === 0) {
                console.log("Average time for all correct clicks (after ", correct_identification_times.length, " total correct clicks):", time_status.textContent);
                // Also print the average time over just the last 5 correct clicks
                if(correct_identification_times.length >= 5) {
                    const last_five = correct_identification_times.slice(-5);
                    const average_time_last_five = last_five.reduce((a, b) => a + b, 0) / last_five.length;
                    console.log("Average time for the last 5 correct clicks (after ", correct_identification_times.length, " total correct clicks):", average_time_last_five / 1000, "s");
                }
            }


            // disable buttons until next question, so user cannot accidently answer twice
            document.querySelectorAll(".answer-btn").forEach(button => {
                button.disabled = true;
            });
            const timeout = isCorrect ? 1000 : 2000;
            setTimeout(renderMusicalNote, timeout);
        }

        // Create answer buttons for the current note system.
        function createAnswerButtons() {
            const container = document.getElementById("buttons");
            container.innerHTML = "";
            noteSystems[currentNotation].forEach(note => {
                const btn = document.createElement("button");
                btn.textContent = note;
                btn.classList.add("answer-btn");
                btn.onclick = () => checkAnswer(note);
                container.appendChild(btn);
            });
        }

        // Start the quiz. Resets score and all timers and statistics.
        function startOver() {
            num_correct = 0;
            num_tries = 0;
            correct_identification_times = [];
            console.log("Starting over...");
            const score_status = document.getElementById("score_status");
            score_status.textContent = `Click the correct note name!`;
            score_status.title = "Go for it!";
            const score_status_percent = document.getElementById("score_status_percent");
            score_status_percent.textContent = "";
            overall_start_time = Date.now();
            const time_status = document.getElementById("time_status");
            time_status.textContent = `?`;
            time_status.title = "Need at least 5 successful identifications.";
            const time_status_last_ten = document.getElementById("time_status_last_ten");
            time_status_last_ten.textContent = `?`;
            time_status_last_ten.title = "Need at least 10 successful identifications.";
            renderMusicalNote();
        }

        // Attach event listener for startover button
        document.getElementById("startOverButton").addEventListener("click", startOver);

        // Attach event listeners for note notation settings
        document.querySelectorAll("input[name='notation']").forEach(radio => {
            radio.addEventListener("change", (event) => {
                currentNotation = event.target.value;
                localStorage.setItem("currentNotation", JSON.stringify(currentNotation)); // Save to localStorage
                createAnswerButtons();
            });
        });

        // Attach event listeners for clef settings
        document.querySelectorAll("input[name='clef']").forEach(radio => {
            radio.addEventListener("change", (event) => {
                currentClef = event.target.value;
                localStorage.setItem("currentClef", JSON.stringify(currentClef)); // Save to localStorage
                renderMusicalNote();
            });
        });

        // Attach event listeners for toggling settings visible vs hidden
        document.getElementById("toggle-settings").addEventListener("click", function() {
            const settingsDiv = document.getElementById("settings");
            const button = this;

            if (window.getComputedStyle(settingsDiv).display === "none") {
                settingsDiv.style.display = "block";
                button.textContent = "▼ Settings"; // Change arrow down
            } else {
                settingsDiv.style.display = "none";
                button.textContent = "▶ Settings"; // Change arrow right
            }
        });

        // Attach event listeners for toggling timings visible vs hidden
        document.getElementById("toggle-timings").addEventListener("click", function() {
            const timingsDiv = document.getElementById("timings");
            const button = this;

            if (window.getComputedStyle(timingsDiv).display === "none") {
                timingsDiv.style.display = "block";
                button.textContent = "▼ Timings"; // Change arrow down
            } else {
                timingsDiv.style.display = "none";
                button.textContent = "▶ Timings"; // Change arrow right
            }
        });

        // Initialize checkboxes
        generateIncludedOctavesCheckboxes();
        createAnswerButtons();
        renderMusicalNote();
    </script>
</body>
</html>
